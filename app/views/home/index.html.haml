= render "page_heading", title: t(".title")

.card.shadow.mb-4
  .card-body
    .d-flex.justify-content-between
      %p= t("paginate_info_html", name: t(".messages"), items_count: @pagy.items, collection_count: @collection.count)
      = simple_form_for :q, method: :get, html: { class: "form" } do
        .date-filter.d-flex.align-items-center.mb-3.justify-content-end
          .date-filter__label
            %span.mr-2
              =t("dashboard.show")
          .date-filter__choose-option
            .input-group
              = render "shared/input_date_range"

    .table-responsive
      %table#dataTable.table{:cellspacing => "0", :width => "100%"}
        %thead
          %tr
            %th= t(".session_id")
            %th.nowrap-space
              = t(".last_interaction_date")
            %th= t(".source")
        %tbody
          - @messages.each_with_index do |message, index|
            %tr
              %td.border-right-0.border-bottom-0
                = link_to "#collapse#{index}", type: "button", data: { toggle: "collapse" }, class: "collapsed btn-collapse btn btn-default btn-sm mr-3" do
                  %i.fas.fa-arrow-right
                = image_tag "#{message.platform_name.downcase}.svg", width: 18
                = message.session_id
              %td.border-left-0.border-right-0.border-bottom-0
                = display_datetime(message.last_interaction_at)
              %td.border-left-0.border-bottom-0
                - result = []
                - @variables.each do |variable|
                  - value = nil
                  - message.step_values.most_recent.each do |step|
                    - if step.variable.name == variable.name
                      - value = step.variable_value.mapping_value
                      - break
                  - result << value
                = result.compact.join(", ")
            %tr
              %td.p-0.border-top-0{ colspan: 3 }
                .p-3.collapse{ id: "collapse#{index}" }
                  .mb-3
                    %i.fas.fa-folder-open.mr-1
                    %strong= t(".expand_document")
                  %table.table.table-sm.table-bordered
                    - message.step_values.most_recent.each do |step|
                      %tr
                        %td.w-25
                          = step.variable.name
                        %td
                          = step.variable_value.mapping_value

    - if @pagy.pages > 1
      != render partial: 'shared/pagy/bootstrap_nav', locals: {pagy: @pagy}
